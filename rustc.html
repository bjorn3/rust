<meta charset="utf-8">
<script type="module">
    (async function () {
        document.body.innerText = "Downloading";
        let wasm = await WebAssembly.compileStreaming(fetch("/target/wasm32-wasi/release/rustc_binary.wasm"));
        document.body.innerText = "Instantiating";

        let args = ["rustc", "-h", "--sysroot", "/sysroot"];

        let inst = await WebAssembly.instantiate(wasm, {
            "wasi_snapshot_preview1": {
                proc_exit() { console.log("proc_exit"); },
                random_get() { console.log("random_get"); },
                args_sizes_get(argc, argv_buf_size) {
                    let buffer8 = new Uint8Array(inst.exports.memory.buffer);
                    let buffer32 = new Uint32Array(inst.exports.memory.buffer);
                    console.log("args_sizes_get(", argc, ", ", argv_buf_size, ")");
                    buffer32[argc / 4] = args.length;
                    let buf_size = 0;
                    for (let arg of args) {
                        buf_size += arg.length + 1;
                    }
                    buffer32[argv_buf_size / 4] = buf_size;
                    console.log(buffer32[argc / 4], buffer32[argv_buf_size / 4]);
                    return 0;
                },
                args_get(argv, argv_buf) {
                    let buffer8 = new Uint8Array(inst.exports.memory.buffer);
                    let buffer32 = new Uint32Array(inst.exports.memory.buffer);
                    console.log("args_get(", argv, ", ", argv_buf, ")");
                    let orig_argv_buf = argv_buf;
                    for (let i = 0; i < args.length; i++) {
                        buffer32[argv / 4] = argv_buf;
                        argv += 4;
                        let arg = new TextEncoder("utf-8").encode(args[i]);
                        buffer8.set(arg, argv_buf);
                        buffer8[argv_buf + arg.length] = 0;
                        argv_buf += arg.length + 1;
                    }
                    console.log(buffer8.slice(orig_argv_buf, argv_buf));
                    console.log(new TextDecoder("utf-8").decode(buffer8.slice(orig_argv_buf, argv_buf)));
                    return 0;
                },
                clock_time_get() { console.log("clock_time_get"); return 0; },
                fd_close() { console.log("fd_close"); },
                fd_filestat_get() { console.log("fd_filestat_get"); },
                fd_read() { console.log("fd_read"); },
                fd_readdir() { console.log("fd_readdir"); },
                fd_seek() { console.log("fd_seek"); },
                fd_write(fd, iovs_ptr, iovs_len, nwritten_ptr) {
                    let buffer8 = new Uint8Array(inst.exports.memory.buffer);
                    let buffer32 = new Uint32Array(inst.exports.memory.buffer);
                    console.log("fd_write(", fd, ", ", iovs_ptr, ", ", iovs_len, ", ", nwritten_ptr);
                    buffer32[nwritten_ptr / 4] = 0;
                    for (let i = 0; i < iovs_len; i++) {
                        let [ptr, len] = [buffer32[iovs_ptr / 4 + 2 * i], buffer32[iovs_ptr / 4 + 2 * i + 1]];
                        document.body.innerText += new TextDecoder("utf-8").decode(buffer8.slice(ptr, ptr + len));
                        console.log(ptr, len);

                        buffer32[nwritten_ptr / 4] += len;
                    }
                    return 0; // errno
                },
                path_create_directory() { console.log("path_create_directory"); },
                path_filestat_get() { console.log("path_filestat_get"); },
                path_link() { console.log("path_link"); },
                path_open() { console.log("path_open"); },
                path_readlink() { console.log("path_readlink"); },
                path_remove_directory() { console.log("path_remove_directory"); },
                path_rename() { console.log("path_rename"); },
                path_unlink_file() { console.log("path_unlink_file"); },
                sched_yield() { console.log("sched_yield"); },
                fd_prestat_get() { console.log("fd_prestat_get"); },
                fd_prestat_dir_name() { console.log("fd_prestat_dir_name"); },
                environ_sizes_get() { console.log("environ_sizes_get"); },
                environ_get() { console.log("environ_get"); }
            }
        });
        document.body.innerText = "Executing\n";
        console.log(inst.exports);
        inst.exports.main();
        document.body.innerText = "Done";
    })();
</script>
